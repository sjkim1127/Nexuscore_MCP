use anyhow::Result;
use serde_json::Value;
use crate::tools::{Tool, ToolSchema, ParamDef};
use crate::utils::response::StandardResponse;
use crate::engine::frida_handler;
use async_trait::async_trait;
use std::time::Instant;

pub struct SslKeyDumper;

#[async_trait]
impl Tool for SslKeyDumper {
    fn name(&self) -> &str { "dump_ssl_keys" }
    fn description(&self) -> &str { "Hooks SSL libraries to dump session keys. Args: pid (number)" }
    fn schema(&self) -> ToolSchema {
        ToolSchema::new(vec![ ParamDef::new("pid", "number", true, "Target process ID") ])
    }

    async fn execute(&self, args: Value) -> Result<Value> {
        let start = Instant::now();
        let tool_name = self.name();
        
        let pid = match args["pid"].as_u64() {
            Some(p) => p as u32,
            None => return Ok(StandardResponse::error(tool_name, "Missing pid")),
        };

        let script = include_str!("../../resources/scripts/ssl_keylog.js");
        
        if let Err(e) = frida_handler::execute_script(pid, script) {
            return Ok(StandardResponse::error(tool_name, &e.to_string()));
        }

        Ok(StandardResponse::success_timed(tool_name, serde_json::json!({
            "pid": pid,
            "targets": ["OpenSSL", "SChannel", "NCrypt"]
        }), start))
    }
}
