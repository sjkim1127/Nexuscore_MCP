use anyhow::Result;
use serde_json::Value;
use crate::tools::Tool;
use crate::engine::frida_handler;
use async_trait::async_trait;

/// Crypto Hook - Captures encryption/decryption operations
pub struct CryptoHook;

#[async_trait]
impl Tool for CryptoHook {
    fn name(&self) -> &str { "crypto_hook" }

    fn description(&self) -> &str {
        "Hooks Windows Crypto APIs to capture plaintext data and keys before encryption. Args: pid (number)"
    }

    async fn execute(&self, args: Value) -> Result<Value> {
        let pid = args["pid"].as_u64().ok_or(anyhow::anyhow!("Missing pid"))? as u32;

        let script = include_str!("../../resources/scripts/crypto_hook.js");
        frida_handler::execute_script(pid, script)?;

        Ok(serde_json::json!({
            "status": "monitoring",
            "pid": pid,
            "hooked_apis": [
                "CryptEncrypt", "CryptDecrypt",
                "BCryptEncrypt", "BCryptDecrypt",
                "CryptHashData"
            ],
            "message": "Crypto operations will be captured via Frida messages."
        }))
    }
}
