use anyhow::Result;
use serde_json::Value;
use crate::tools::Tool;
use crate::engine::frida_handler;
use async_trait::async_trait;

/// Child Process Trapper - Monitors child process creation
pub struct ChildTrapper;

#[async_trait]
impl Tool for ChildTrapper {
    fn name(&self) -> &str { "monitor_children" }
    fn description(&self) -> &str { "Detects and reports child process creation (CreateProcess, ShellExecute). Args: pid (number)" }

    async fn execute(&self, args: Value) -> Result<Value> {
        let pid = args["pid"].as_u64().ok_or(anyhow::anyhow!("Missing pid"))? as u32;

        let script = r#"
            var childCount = 0;

            // Hook CreateProcessW
            var CreateProcessW = Module.findExportByName('kernel32.dll', 'CreateProcessW');
            if (CreateProcessW) {
                Interceptor.attach(CreateProcessW, {
                    onEnter: function(args) {
                        this.appName = args[0].isNull() ? null : args[0].readUtf16String();
                        this.cmdLine = args[1].isNull() ? null : args[1].readUtf16String();
                        this.lpProcessInfo = args[9]; // LPPROCESS_INFORMATION
                    },
                    onLeave: function(retval) {
                        if (retval.toInt32() !== 0) {
                            childCount++;
                            var childPid = 0;
                            try {
                                // PROCESS_INFORMATION: hProcess, hThread, dwProcessId, dwThreadId
                                childPid = this.lpProcessInfo.add(8).readU32(); // offset 8 for dwProcessId
                            } catch (e) {}
                            
                            send({
                                type: 'child_spawn',
                                api: 'CreateProcessW',
                                application: this.appName,
                                commandLine: this.cmdLine,
                                childPid: childPid
                            });
                        }
                    }
                });
            }

            // Hook CreateProcessA
            var CreateProcessA = Module.findExportByName('kernel32.dll', 'CreateProcessA');
            if (CreateProcessA) {
                Interceptor.attach(CreateProcessA, {
                    onEnter: function(args) {
                        this.appName = args[0].isNull() ? null : args[0].readCString();
                        this.cmdLine = args[1].isNull() ? null : args[1].readCString();
                        this.lpProcessInfo = args[9];
                    },
                    onLeave: function(retval) {
                        if (retval.toInt32() !== 0) {
                            childCount++;
                            var childPid = 0;
                            try {
                                childPid = this.lpProcessInfo.add(8).readU32();
                            } catch (e) {}
                            
                            send({
                                type: 'child_spawn',
                                api: 'CreateProcessA',
                                application: this.appName,
                                commandLine: this.cmdLine,
                                childPid: childPid
                            });
                        }
                    }
                });
            }

            // Hook ShellExecuteW
            var ShellExecuteW = Module.findExportByName('shell32.dll', 'ShellExecuteW');
            if (ShellExecuteW) {
                Interceptor.attach(ShellExecuteW, {
                    onEnter: function(args) {
                        this.operation = args[1].isNull() ? null : args[1].readUtf16String();
                        this.file = args[2].isNull() ? null : args[2].readUtf16String();
                        this.params = args[3].isNull() ? null : args[3].readUtf16String();
                    },
                    onLeave: function(retval) {
                        if (retval.toInt32() > 32) { // Success is > 32
                            childCount++;
                            send({
                                type: 'child_spawn',
                                api: 'ShellExecuteW',
                                operation: this.operation,
                                file: this.file,
                                parameters: this.params
                            });
                        }
                    }
                });
            }

            send({ type: 'child_monitor_active', hooked: ['CreateProcessW', 'CreateProcessA', 'ShellExecuteW'] });
            console.log('[NexusCore] Child Process Trapper active');
        "#;

        frida_handler::execute_script(pid, script)?;

        Ok(serde_json::json!({
            "status": "child_monitor_active",
            "pid": pid,
            "hooked_apis": ["CreateProcessW", "CreateProcessA", "ShellExecuteW"],
            "note": "Child process spawns will be reported via Frida messages"
        }))
    }
}
