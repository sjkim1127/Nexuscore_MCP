use anyhow::Result;
use serde_json::Value;
use crate::tools::Tool;
use crate::engine::frida_handler;
use async_trait::async_trait;

/// SSL Keylogger - Extracts TLS session keys for Wireshark decryption
pub struct SslKeylogger;

#[async_trait]
impl Tool for SslKeylogger {
    fn name(&self) -> &str { "ssl_keylog" }

    fn description(&self) -> &str {
        "Extracts TLS/SSL session keys in SSLKEYLOGFILE format for Wireshark decryption. Args: pid (number)"
    }

    async fn execute(&self, args: Value) -> Result<Value> {
        let pid = args["pid"].as_u64().ok_or(anyhow::anyhow!("Missing pid"))? as u32;

        let script = include_str!("../../resources/scripts/ssl_keylog.js");
        frida_handler::execute_script(pid, script)?;

        Ok(serde_json::json!({
            "status": "monitoring",
            "pid": pid,
            "targets": ["schannel.dll (Windows TLS)", "OpenSSL (if present)"],
            "output_format": "SSLKEYLOGFILE (NSS Key Log Format)",
            "message": "TLS session keys will be sent via Frida messages. Save them to a file and use with Wireshark."
        }))
    }
}
