use anyhow::Result;
use serde_json::Value;
use crate::tools::Tool;
use crate::engine::frida_handler;
use async_trait::async_trait;

/// Time Warper - Bypasses time-based sandbox evasion (Sleep, WaitForSingleObject)
pub struct TimeWarper;

#[async_trait]
impl Tool for TimeWarper {
    fn name(&self) -> &str { "warp_time" }
    fn description(&self) -> &str { "Hooks Sleep APIs to bypass time-based evasion techniques. Args: pid (number), threshold_ms (default 1000)" }

    async fn execute(&self, args: Value) -> Result<Value> {
        let pid = args["pid"].as_u64().ok_or(anyhow::anyhow!("Missing pid"))? as u32;
        let threshold = args["threshold_ms"].as_u64().unwrap_or(1000);

        let script = format!(r#"
            var warped = 0;
            var threshold = {};

            // Hook Sleep
            var Sleep = Module.findExportByName('kernel32.dll', 'Sleep');
            if (Sleep) {{
                Interceptor.attach(Sleep, {{
                    onEnter: function(args) {{
                        var duration = args[0].toInt32();
                        if (duration > threshold) {{
                            send({{ type: 'time_warp', api: 'Sleep', original_ms: duration, warped_to: 0 }});
                            args[0] = ptr(0);
                            warped++;
                        }}
                    }}
                }});
            }}

            // Hook SleepEx
            var SleepEx = Module.findExportByName('kernel32.dll', 'SleepEx');
            if (SleepEx) {{
                Interceptor.attach(SleepEx, {{
                    onEnter: function(args) {{
                        var duration = args[0].toInt32();
                        if (duration > threshold) {{
                            send({{ type: 'time_warp', api: 'SleepEx', original_ms: duration, warped_to: 0 }});
                            args[0] = ptr(0);
                            warped++;
                        }}
                    }}
                }});
            }}

            // Hook WaitForSingleObject
            var WaitForSingleObject = Module.findExportByName('kernel32.dll', 'WaitForSingleObject');
            if (WaitForSingleObject) {{
                Interceptor.attach(WaitForSingleObject, {{
                    onEnter: function(args) {{
                        var timeout = args[1].toInt32();
                        if (timeout > threshold && timeout !== -1) {{
                            send({{ type: 'time_warp', api: 'WaitForSingleObject', original_ms: timeout, warped_to: 0 }});
                            args[1] = ptr(0);
                            warped++;
                        }}
                    }}
                }});
            }}

            // Hook NtDelayExecution (ntdll - lower level)
            var NtDelayExecution = Module.findExportByName('ntdll.dll', 'NtDelayExecution');
            if (NtDelayExecution) {{
                Interceptor.attach(NtDelayExecution, {{
                    onEnter: function(args) {{
                        // DelayInterval is a LARGE_INTEGER pointer (100ns units)
                        try {{
                            var intervalPtr = args[1];
                            var low = intervalPtr.readU32();
                            var high = intervalPtr.add(4).readU32();
                            var nsec = (high * 0x100000000 + low) * 100;
                            var msec = nsec / 1000000;
                            if (msec > threshold) {{
                                send({{ type: 'time_warp', api: 'NtDelayExecution', original_ms: msec, warped_to: 0 }});
                                intervalPtr.writeU64(0);
                                warped++;
                            }}
                        }} catch (e) {{}}
                    }}
                }});
            }}

            send({{ type: 'time_warp_active', threshold_ms: threshold }});
            console.log('[NexusCore] Time Warper active. Threshold: ' + threshold + 'ms');
        "#, threshold);

        frida_handler::execute_script(pid, &script)?;

        Ok(serde_json::json!({
            "status": "time_warp_active",
            "pid": pid,
            "threshold_ms": threshold,
            "hooked_apis": ["Sleep", "SleepEx", "WaitForSingleObject", "NtDelayExecution"]
        }))
    }
}
