use anyhow::Result;
use serde_json::Value;
use crate::tools::{Tool, ToolSchema, ParamDef};
use crate::utils::response::StandardResponse;
use crate::engine::frida_handler;
use async_trait::async_trait;
use std::time::Instant;

pub struct TimeWarper;

#[async_trait]
impl Tool for TimeWarper {
    fn name(&self) -> &str { "warp_time" }
    fn description(&self) -> &str { "Hooks Sleep APIs to bypass time-based evasion. Args: pid, threshold_ms (default 1000)" }
    fn schema(&self) -> ToolSchema {
        ToolSchema::new(vec![
            ParamDef::new("pid", "number", true, "Target process ID"),
            ParamDef::new("threshold_ms", "number", false, "Threshold in ms (default: 1000)"),
        ])
    }

    async fn execute(&self, args: Value) -> Result<Value> {
        let start = Instant::now();
        let tool_name = self.name();
        
        let pid = match args["pid"].as_u64() {
            Some(p) => p as u32,
            None => return Ok(StandardResponse::error(tool_name, "Missing pid")),
        };
        let threshold = args["threshold_ms"].as_u64().unwrap_or(1000);

        let script = format!(r#"
            var threshold = {};
            ['Sleep', 'SleepEx'].forEach(function(api) {{
                var fn = Module.findExportByName('kernel32.dll', api);
                if (fn) {{
                    Interceptor.attach(fn, {{
                        onEnter: function(args) {{
                            var d = args[0].toInt32();
                            if (d > threshold) {{ args[0] = ptr(0); send({{type:'time_warp', api:api, ms:d}}); }}
                        }}
                    }});
                }}
            }});
            send({{type:'active', threshold:threshold}});
        "#, threshold);

        if let Err(e) = frida_handler::execute_script(pid, &script) {
            return Ok(StandardResponse::error(tool_name, &e.to_string()));
        }

        Ok(StandardResponse::success_timed(tool_name, serde_json::json!({
            "pid": pid,
            "threshold_ms": threshold,
            "hooked_apis": ["Sleep", "SleepEx"]
        }), start))
    }
}
