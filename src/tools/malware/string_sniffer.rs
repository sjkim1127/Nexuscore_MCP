use anyhow::Result;
use serde_json::Value;
use crate::tools::Tool;
use crate::engine::frida_handler;
use async_trait::async_trait;

/// String Sniffer - Captures runtime-decrypted strings
pub struct StringSniffer;

#[async_trait]
impl Tool for StringSniffer {
    fn name(&self) -> &str { "string_sniffer" }

    fn description(&self) -> &str {
        "Captures strings that are decrypted/generated at runtime by hooking memory allocations. Args: pid (number)"
    }

    async fn execute(&self, args: Value) -> Result<Value> {
        let pid = args["pid"].as_u64().ok_or(anyhow::anyhow!("Missing pid"))? as u32;

        let script = include_str!("../../resources/scripts/string_sniffer.js");
        frida_handler::execute_script(pid, script)?;

        Ok(serde_json::json!({
            "status": "monitoring",
            "pid": pid,
            "message": "String sniffer active. Captured strings will be sent via Frida messages."
        }))
    }
}
