use anyhow::Result;
use serde_json::Value;
use crate::tools::Tool;
use async_trait::async_trait;
use std::process::Command;

/// PE-Sieve Wrapper - Detects Process Hollowing, DLL Injection
pub struct PeSieve;

#[async_trait]
impl Tool for PeSieve {
    fn name(&self) -> &str { "scan_pe_sieve" }
    fn description(&self) -> &str { "Scans a process for memory anomalies (hollowing, injection). Args: pid (number)" }

    async fn execute(&self, args: Value) -> Result<Value> {
        let pid = args["pid"].as_u64().ok_or(anyhow::anyhow!("Missing pid"))? as u32;

        // Run pe-sieve64.exe
        let output = Command::new("pe-sieve64.exe")
            .args(["/pid", &pid.to_string(), "/json", "/quiet"])
            .output()
            .map_err(|e| anyhow::anyhow!("Failed to run pe-sieve64.exe: {}. Is it in PATH?", e))?;

        let stdout = String::from_utf8_lossy(&output.stdout);
        let stderr = String::from_utf8_lossy(&output.stderr);

        // Try to parse JSON output
        let result: Value = serde_json::from_str(&stdout).unwrap_or_else(|_| {
            serde_json::json!({
                "raw_output": stdout.to_string(),
                "stderr": stderr.to_string()
            })
        });

        // Extract key findings
        let suspicious = result["scanned"]["total"].as_u64().unwrap_or(0);
        let replaced = result["scanned"]["replaced"].as_u64().unwrap_or(0);
        let implanted = result["scanned"]["implanted"].as_u64().unwrap_or(0);
        let hollowed = result["scanned"]["hollowed"].as_u64().unwrap_or(0);

        Ok(serde_json::json!({
            "pid": pid,
            "status": if replaced > 0 || implanted > 0 || hollowed > 0 { "SUSPICIOUS" } else { "CLEAN" },
            "summary": {
                "total_modules": suspicious,
                "hollowed": hollowed,
                "implanted": implanted,
                "replaced": replaced
            },
            "details": result
        }))
    }
}
