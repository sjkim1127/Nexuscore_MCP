use anyhow::Result;
use serde_json::Value;
use crate::tools::{Tool, ToolSchema, ParamDef};
use crate::utils::response::StandardResponse;
use async_trait::async_trait;
use std::process::Command;
use std::time::Instant;

pub struct PeSieve;

#[async_trait]
impl Tool for PeSieve {
    fn name(&self) -> &str { "scan_pe_sieve" }
    fn description(&self) -> &str { "Scans a process for memory anomalies (hollowing, injection). Args: pid (number)" }
    fn schema(&self) -> ToolSchema {
        ToolSchema::new(vec![ ParamDef::new("pid", "number", true, "Target process ID") ])
    }

    async fn execute(&self, args: Value) -> Result<Value> {
        let start = Instant::now();
        let tool_name = self.name();
        
        let pid = match args["pid"].as_u64() {
            Some(p) => p as u32,
            None => return Ok(StandardResponse::error(tool_name, "Missing pid")),
        };

        let output = match Command::new("pe-sieve64.exe")
            .args(["/pid", &pid.to_string(), "/json", "/quiet"])
            .output() {
            Ok(o) => o,
            Err(e) => return Ok(StandardResponse::error(tool_name, &format!("pe-sieve64.exe failed: {}", e))),
        };

        let stdout = String::from_utf8_lossy(&output.stdout);
        let result: Value = serde_json::from_str(&stdout).unwrap_or(serde_json::json!({"raw": stdout.to_string()}));

        let replaced = result["scanned"]["replaced"].as_u64().unwrap_or(0);
        let implanted = result["scanned"]["implanted"].as_u64().unwrap_or(0);
        let hollowed = result["scanned"]["hollowed"].as_u64().unwrap_or(0);
        let suspicious = replaced > 0 || implanted > 0 || hollowed > 0;

        Ok(StandardResponse::success_timed(tool_name, serde_json::json!({
            "pid": pid,
            "verdict": if suspicious { "SUSPICIOUS" } else { "CLEAN" },
            "hollowed": hollowed,
            "implanted": implanted,
            "replaced": replaced,
            "details": result
        }), start))
    }
}
